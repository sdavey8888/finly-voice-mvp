<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Finly Voice Assessment</title>
</head>
<body>
  <h2>Voice Assessment â€“ Question 1</h2>
  <p>Question: What is TDS and how would you journalize it?</p>

  <button id="start">Start Recording</button>
  <button id="stop" disabled>Stop Recording</button>

  <h3>Your Transcript:</h3>
  <textarea id="transcript" rows="6" cols="80"></textarea>

  <h3>Evaluation Result:</h3>
  <pre id="geminiOutput">-- Awaiting --</pre>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const transcriptArea = document.getElementById("transcript");

    startBtn.onclick = async () => {
      audioChunks = [];

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks);

        // Convert audio to base64 (for sending to Speech-to-Text API)
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64Audio = reader.result.split(',')[1];

          // Simulated response
          const mockTranscript = "TDS is deducted on certain payments like salary and professional fees. We credit the TDS payable and debit the expense.";
          transcriptArea.value = mockTranscript;

          const response = await fetch("/evaluate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: "What is TDS and how would you journalize it?", answer: mockTranscript })
          });

          const result = await response.json();
          document.getElementById("geminiOutput").innerText = JSON.stringify(result, null, 2);
        };
        reader.readAsDataURL(audioBlob);
      };

      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
  </script>
</body>
</html>
